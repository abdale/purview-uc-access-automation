<p>Consider a scenario where an analyst using Power BI needs to securely access and query data assets in a Databricks workspace&mdash;without having direct access to the workspace itself. Non-Databricks users can take advantage of <a class="lia-external-url" href="https://learn.microsoft.com/en-ca/azure/databricks/delta-sharing/" target="_blank" rel="noopener">Delta Sharing</a> in Databricks, which enables secure data access to data and AI assets in Databricks for users inside or outside your organization through the Databricks <a class="lia-external-url" href="https://learn.microsoft.com/en-ca/azure/databricks/delta-sharing/share-data-open" target="_blank" rel="noopener">open sharing protocol</a>. Additionally, since these users would not have access to Databricks Catalog Explorer&mdash;hindering their ability to find any Unity Catalog-managed data&mdash;Microsoft Purview can be used to allow users from across your organization to discover and request access securely to this data. By leveraging Microsoft Purview&rsquo;s integration with Unity Catalog, Purview users can discover and access Unity Catalog-managed data in a governed and secure manner.</p>
<p>The following step-by-step guidance explains how to enable external users to explore and request access to data assets in a Databricks workspace&mdash;without having direct access to that workspace&mdash;by simply using the Microsoft Purview UI. By leveraging Purview&rsquo;s <a class="lia-external-url" href="https://learn.microsoft.com/en-us/purview/register-scan-azure-databricks-unity-catalog?tabs=MI" target="_blank" rel="noopener">Azure Databricks Unity Catalog connector</a>, the metadata for the assets in Unity Catalog is made discoverable in the Purview data map. The ability to request and grant access to Unity Catalog objects in an automated fashion is made possible through Purview&rsquo;s self-service access workflows, in conjunction with calling the Databricks REST API, as shown below.</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWdQblR1Ng?image-dimensions=750x750&amp;revision=1" id="gPnTu6" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>The following steps will automate access requests to Databricks Unity Catalog using Purview workflows and the Databricks REST API resulting in a seamless experience for the end user.</p>
<h2>Step 1: Setup prerequisites</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/purview/register-scan-azure-databricks-unity-catalog?tabs=SP#tabpanel_1_SP" target="_blank" rel="noopener">Setup service principal for Azure Databricks authentication and add it as a credential in Purview</a></li>
<li><a href="https://learn.microsoft.com/en-us/purview/register-scan-azure-databricks-unity-catalog?tabs=MI" target="_blank" rel="noopener">Setup connection to Azure Databricks Unity Catalog from Microsoft Purview</a></li>
<li><a href="https://learn.microsoft.com/en-us/purview/register-scan-azure-databricks-unity-catalog?tabs=MI#scan" target="_blank" rel="noopener">Scan Azure Databricks to automatically identify assets in Microsoft Purview</a></li>
<li>Confirm availability of assets (e.g., Databricks tables) by <a href="https://learn.microsoft.com/en-us/purview/register-scan-azure-databricks-unity-catalog?tabs=MI#browse-and-search-assets" target="_blank" rel="noopener">browsing and searching in the Microsoft Purview Unified Catalog</a></li>
</ul>
<h2>Step 2: Create Databricks notebook</h2>
<p>In your Azure Databricks workspace, create a new Databricks notebook with the following cells to programmatically call the Databricks REST API to create and share a Delta share for the requested data asset with the intended recipient:</p>
<h3>Create widgets and import libraries</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-11"># Create widgets to retrieve parameters from Purview workflow</span><br>dbutils.widgets.text("assetFQName", "")<br>dbutils.widgets.text("requestorID", "")<br><br># Import libraries<br>import requests<br>import json</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Setup authentication to request token</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-11"># Function to request token using service principal with Databricks scope secret</span><br>def request_token():<br>&nbsp; &nbsp; client_id = dbutils.secrets.get(scope="azure_auth", key="client_id")<br>&nbsp; &nbsp; client_secret = dbutils.secrets.get(scope="azure_auth", key="client_secret")<br>&nbsp; &nbsp; tenant_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"<br>&nbsp; &nbsp; scope = "2ff814a6-3304-4ab8-85cb-cd0e6f879c1d/.default" <span class="lia-text-color-11">#OAuth scope used specifically for Azure Databricks</span><br>&nbsp; &nbsp;&nbsp;<br>&nbsp; &nbsp; url = f"https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token"<br>&nbsp; &nbsp; headers = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Content-Type': 'application/x-www-form-urlencoded'<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; data = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'grant_type': 'client_credentials',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'client_id': client_id,<br>&nbsp; &nbsp; &nbsp; &nbsp; 'client_secret': client_secret,<br>&nbsp; &nbsp; &nbsp; &nbsp; 'scope': scope<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; response = requests.post(url, headers=headers, data=data)<br>&nbsp; &nbsp; response.raise_for_status()<br>&nbsp; &nbsp; return response.json()['access_token']</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Extract information from Purview parameters</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" height="23.6667px" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr height="23.6667px"><li-td name="td" height="23.6667px">
<pre><span class="lia-text-color-11">&nbsp;# Function to extract catalog.schema.table from a fully qualified asset path in Purview</span><br>def derive_asset_name(asset_fqname):<br>&nbsp; &nbsp; parts = asset_fqname.split('/')<br>&nbsp; &nbsp; catalog = parts[4]<br>&nbsp; &nbsp; schema = parts[6]<br>&nbsp; &nbsp; table = parts[8]<br>&nbsp; &nbsp; return f"{catalog}.{schema}.{table}"</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Create Delta share</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" height="23.6667px" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr height="23.6667px"><li-td name="td" height="23.6667px">
<pre><span class="lia-text-color-11"># Function to create a Delta share</span><br>def create_share(token, share_name, workspace_url):<br>&nbsp; &nbsp; url = f"{workspace_url}/api/2.1/unity-catalog/shares"<br>&nbsp; &nbsp; headers = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Authorization': f'Bearer {token}',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Content-Type': 'application/json'<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; data = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'name': share_name<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; response = requests.post(url, headers=headers, json=data)<br>&nbsp; &nbsp; if response.status_code == 200:<br>&nbsp; &nbsp; &nbsp; &nbsp; return response.json()<br>&nbsp; &nbsp; elif response.status_code == 400 and response.json().get('error_code') == 'SHARE_ALREADY_EXISTS':<br>&nbsp; &nbsp; &nbsp; &nbsp; return None<br>&nbsp; &nbsp; else:<br>&nbsp; &nbsp; &nbsp; &nbsp; response.raise_for_status()</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Add data object to share</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" height="23.6667px" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr height="23.6667px"><li-td name="td" height="23.6667px">
<pre><span class="lia-text-color-11"># Function to add data object to the share</span><br>def add_data_object_to_share(token, share_name, asset_name, workspace_url):<br>&nbsp; &nbsp; url = f"{workspace_url}/api/2.1/unity-catalog/shares/{share_name}"<br>&nbsp; &nbsp; headers = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Authorization': f'Bearer {token}',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Content-Type': 'application/json'<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; data = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'name': share_name,<br>&nbsp; &nbsp; &nbsp; &nbsp; 'updates': [<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'action': 'ADD',<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'data_object': {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'data_object_type': 'TABLE',<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'history_data_sharing_status': 'ENABLED',<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'name': asset_name,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'status': 'ACTIVE'<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; ]<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; response = requests.patch(url, headers=headers, json=data)<br>&nbsp; &nbsp; if response.status_code == 200:<br>&nbsp; &nbsp; &nbsp; &nbsp; return response.json()<br>&nbsp; &nbsp; elif response.status_code == 400 and response.json().get('error_code') == 'RESOURCE_ALREADY_EXISTS':<br>&nbsp; &nbsp; &nbsp; &nbsp; return None<br>&nbsp; &nbsp; else:<br>&nbsp; &nbsp; &nbsp; &nbsp; response.raise_for_status()</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Create share recipient</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-11"># Function to create a recipient</span><br>def create_recipient(token, requestor_id, workspace_url):<br>&nbsp; &nbsp; url = f"{workspace_url}/api/2.1/unity-catalog/recipients"<br>&nbsp; &nbsp; headers = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Authorization': f'Bearer {token}',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Content-Type': 'application/json'<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; data = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'authentication_type': 'TOKEN',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'name': requestor_id<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; response = requests.post(url, headers=headers, json=data)<br>&nbsp; &nbsp; if response.status_code == 200:<br>&nbsp; &nbsp; &nbsp; &nbsp; return response.json()<br>&nbsp; &nbsp; elif response.status_code == 400 and response.json().get('error_code') == 'RECIPIENT_ALREADY_EXISTS':<br>&nbsp; &nbsp; &nbsp; &nbsp; return None<br>&nbsp; &nbsp; else:<br>&nbsp; &nbsp; &nbsp; &nbsp; response.raise_for_status()</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Add recipient to share</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-11"># Function to add recipient to the share with select permissions</span><br>def add_recipient_to_share(token, requestor_id, share_name, workspace_url):<br>&nbsp; &nbsp; url = f"{workspace_url}/api/2.1/unity-catalog/shares/{share_name}/permissions"<br>&nbsp; &nbsp; headers = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Authorization': f'Bearer {token}',<br>&nbsp; &nbsp; &nbsp; &nbsp; 'Content-Type': 'application/json'<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; data = {<br>&nbsp; &nbsp; &nbsp; &nbsp; 'changes': [<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'principal': requestor_id,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'remove': [],<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'add': ['SELECT']<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; ]<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; response = requests.patch(url, headers=headers, json=data)<br>&nbsp; &nbsp; response.raise_for_status()<br>&nbsp; &nbsp; return response.json()</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h3>Execute API calls to the Databricks REST API</h3>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table class="lia-background-color-16" width="100%" border="1"><li-tcols cols="99.9074%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-11"># Main function to execute all API calls</span><br>def main():<br>&nbsp; &nbsp; # Retrieve the values of the parameters<br>&nbsp; &nbsp; asset_fqname = dbutils.widgets.get("assetFQName")<br>&nbsp; &nbsp; requestor_id = dbutils.widgets.get("requestorID")<br>&nbsp; &nbsp;&nbsp;<br>&nbsp; &nbsp; workspace_url = 'https://adb-xxxxxxxxxxxxxxx.xx.azuredatabricks.net'<br>&nbsp; &nbsp; asset_name = derive_asset_name(asset_fqname)<br>&nbsp; &nbsp; share_name = asset_name.replace('.', '_')<br>&nbsp; &nbsp; try:<br>&nbsp; &nbsp; &nbsp; &nbsp; token = request_token()<br>&nbsp; &nbsp; &nbsp; &nbsp; create_share(token, share_name, workspace_url)<br>&nbsp; &nbsp; &nbsp; &nbsp; add_data_object_to_share(token, share_name, asset_name, workspace_url)<br>&nbsp; &nbsp; &nbsp; &nbsp; create_recipient(token, requestor_id, workspace_url)<br>&nbsp; &nbsp; &nbsp; &nbsp; add_recipient_to_share(token, requestor_id, share_name, workspace_url)<br>&nbsp; &nbsp; &nbsp; &nbsp; print("All API calls executed successfully.")<br>&nbsp; &nbsp; except requests.exceptions.RequestException as e:<br>&nbsp; &nbsp; &nbsp; &nbsp; print(f"An error occurred: {e}")<br><br>if __name__ == "__main__":<br>&nbsp; &nbsp; main()</pre>
</li-td></li-tr></li-tsection></li-table></div>
<h2>Step 3: Configure Databricks workflow</h2>
<p>Create a new<span style="color: rgb(30, 30, 30);"> Databricks workflow as shown below with the notebook created above as a task.</span></p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLU1zVUFUSw?image-dimensions=750x750&amp;revision=1" id="MsUATK" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<blockquote>
<p>Make sure to note down the "<strong>Job ID</strong>" as it will be required later.</p>
</blockquote>
<h2>Step 4: Configure Purview workflow</h2>
<p>1 - Create a new workflow in Microsoft Purview by going to &ldquo;Solutions&rdquo; and selecting &ldquo;Workflows&rdquo;.</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLTlRZjhjRA?image-dimensions=750x750&amp;revision=1" id="9Qf8cD" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>2 - When&nbsp;<em>adding the new workflow</em>, select &ldquo;<strong>Governance</strong>&rdquo; as the <em>workflow type</em>, select &ldquo;<strong>Data access request</strong>&rdquo; as the <em>template</em>, and provide a <em>name</em>, e.g., &ldquo;Databricks access request&rdquo;. A generic template of the workflow is generated for data access requests, we will need to modify this to suit our scenario. <strong>Delete</strong> the action containing the &ldquo;condition&rdquo; action to clean the workflow slate as shown below.</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWZpMlE5Sg?image-dimensions=750x750&amp;revision=1" id="fi2Q9J" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>3 - Let&rsquo;s start by modifying the &ldquo;start and wait for an approval&rdquo; step to include a more descriptive title for the email that is sent out, assign the approval to the asset owner and set any reminders.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLTU1dUZkTQ?image-dimensions=750x750&amp;revision=1" id="55uFdM" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>4 - Create a new step/action and choose &ldquo;condition&rdquo;. Select &ldquo;Add dynamic content&rdquo; and select &ldquo;Approval.Outcome&rdquo;.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWh1ZUs4ag?image-dimensions=750x750&amp;revision=1" id="hueK8j" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>5 - Enter &ldquo;Approved&rdquo; for the value as shown below.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLUJwVHJjbw?image-dimensions=750x750&amp;revision=1" id="BpTrco" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>6 - Create &ldquo;send email notification&rdquo; action for the &ldquo;If no&rdquo; condition (on the right) by modifying the title, subject, message body and recipient (add dynamic content then select &ldquo;Workflow.Requestor) as follows:&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLVlhV3NWRw?image-dimensions=750x750&amp;revision=1" id="YaWsVG" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>7 - Create the following actions in the &ldquo;If yes&rdquo; condition (on the left) in this order:</p>
<p>(i)<strong> HTTP</strong>: Trigger Databricks Workflow&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLTZFYWdvSg?image-dimensions=750x750&amp;revision=1" id="6EagoJ" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<ul>
<li><strong>Host</strong>: Enter the URL for the Databricks workspace attached to the Unity Catalog metastore that contains the asset associated with this request.</li>
<li><strong>Method</strong>: POST</li>
<li><strong>Path</strong>: /api/2.2/jobs/run-now</li>
<li><strong>Body</strong>:
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table width="100%" border="1"><li-tcols cols="99.9038%"></li-tcols><li-tsection name="tbody"><li-tr><li-td name="td">
<pre><span class="lia-text-color-15">{ </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "job_id": &lt;databricks-job-id&gt;, </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "queue": { "enabled": true }, </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "notebook_params": </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;"assetFQName": <em>"</em><em>⁠</em><em>Asset.Fully Qualified Name</em><em>⁠</em><em>"</em>, </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;"requestorID": <em>"</em><em>⁠</em><em>Workflow.Requestor</em><em>⁠</em><em>"</em> </span><br><span class="lia-text-color-15"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } </span><br><span class="lia-text-color-15"> }</span></pre>
</li-td></li-tr></li-tsection></li-table></div>
<blockquote><strong>Note</strong>: Use &ldquo;<strong>Add dynamic content</strong>&rdquo; to pass the asset&rsquo;s fully qualified name (Asset.Fully Qualified Name⁠) and requestor&rsquo;s object id &nbsp;(⁠Workflow.Requestor⁠) as parameters to the Databricks workflow.</blockquote>
</li>
<li><strong>Authentication</strong>: Service Principal</li>
<li><strong>Credential</strong>: &lt;service-principal&gt;</li>
<li><strong>Audience</strong>: 2ff814a6-3304-4ab8-85cb-cd0e6f879c1d/.default</li>
</ul>
<p>(ii) <strong>Delay</strong>: Set a 2-minute delay to allow for the Databricks workflow to complete</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWhlRkcyWg?image-dimensions=750x750&amp;revision=1" id="heFG2Z" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>(iii) <strong>HTTP</strong>: Get Activation URL&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWwyWmg2Tg?image-dimensions=750x750&amp;revision=1" id="l2Zh6N" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<ul>
<li><strong>Host</strong>: Enter the URL for the Databricks workspace attached to the Unity Catalog metastore that contains the asset associated with this request.</li>
<li><strong>Method</strong>: GET</li>
<li><strong>Path</strong>: /api/2.1/unity-catalog/recipients/&lt;workflow-requestor-id&gt;
<blockquote><strong>Note</strong>: Insert workflow requestor using the &ldquo;Add dynamic content&rdquo; option to use the requestor&rsquo;s object id dynamically in the API call.</blockquote>
</li>
</ul>
<p>(iv) <strong>Parse JSON</strong>: Extract URL</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLXhaWmpBNw?image-dimensions=750x750&amp;revision=1" id="xZZjA7" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<ul>
<li><strong>Content</strong>: Use the &ldquo;Add dynamic content&rdquo; option to insert the &ldquo;<strong>Http.Body</strong>&rdquo; variable from the &ldquo;Get Requestor Email&rdquo; HTTP action created previously.</li>
<li><strong>Schema</strong>:<br>
<div class="styles_lia-table-wrapper__h6Xo9 styles_table-responsive__MW0lN"><li-table width="100%" height="23.6667px" border="1"><li-tcols cols="99.9038%"></li-tcols><li-tsection name="tbody"><li-tr height="23.6667px"><li-td name="td" height="23.6667px">
<pre><span class="lia-text-color-15">{</span><br><span class="lia-text-color-15">&nbsp; &nbsp; "type": "object",</span><br><span class="lia-text-color-15">&nbsp; &nbsp; "properties": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "created_by": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "name": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "updated_by": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "securable_kind": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "authentication_type": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "id": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "properties_kvpairs": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "object",</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "properties": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "properties": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "object",</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "properties": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "databricks.name": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "owner": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "updated_at": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "integer"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "full_name": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "securable_type": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "created_at": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "integer"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; "tokens": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "array",</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "items": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "object",</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "properties": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "updated_by": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "id": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "created_at": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "integer"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "updated_at": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "integer"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "activation_url": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "created_by": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "string"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "expiration_time": {</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "type": "integer"</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; &nbsp; &nbsp; }</span><br><span class="lia-text-color-15">&nbsp; &nbsp; }</span><br><span class="lia-text-color-15">}</span></pre>
</li-td></li-tr></li-tsection></li-table></div>
</li>
</ul>
<p>(v) <strong>Send email notification</strong>:</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWtFd0U4TA?image-dimensions=750x750&amp;revision=1" id="kEwE8L" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<ul>
<li><strong>Subject</strong>: Write &ldquo;Access Request &ndash; APPROVED&rdquo; or something similar.</li>
<li><strong>Message body</strong>: Write the message you would like to send and use &ldquo;Add dynamic content&rdquo; to dynamically pass the access URL for the Delta Share to the requestor by inserting the following expression:&nbsp;<span class="lia-text-color-8">first(outputs('Extract URL')['tokens'])['activation_url']&nbsp;</span></li>
</ul>
<p>8 - Apply workflow to the appropriate scope and save it.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWdiZXEyaw?image-dimensions=750x750&amp;revision=1" id="gbeq2k" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<h2>Step 5: Verify the user experience</h2>
<p>A user browsing delta tables in the Microsoft Purview Unified Catalog may request access directly to the table as shown below, triggering the workflow configured above.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLWJ6MUxTNA?image-dimensions=750x750&amp;revision=1" id="bz1LS4" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>Once the request is submitted, this triggers the Purview workflow created above. The first action, as defined in the workflow associated with this data asset, is to send an email notification to the listed &ldquo;Owner&rdquo; of the asset (go to Edit &gt; Contacts to check) to approve this access request.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLVhNd1huSQ?image-dimensions=750x750&amp;revision=1" id="XMwXnI" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>Once the request is approved, the Purview workflow triggers the Databricks workflow to make the required Databricks REST API calls for creating and sharing the data asset through Open Delta Sharing. Shortly after the Delta share is created and recipient is added in Azure Databricks, the Purview workflow retrieves the activation URL to access the share and sends it to the requestor.&nbsp;</p>
<li-image src="https://techcommunity.microsoft.com/t5/s/gxcuf89792/images/bS00NDI4MDEwLVliVzhmcw?image-dimensions=750x750&amp;revision=1" id="YbW8fs" caption="false" alt="" align="center" resized="false" size="default" layout="stretch" name=""></li-image>
<p>After downloading the shared credential file from the activation URL, the requestor can <a href="https://learn.microsoft.com/en-ca/azure/databricks/delta-sharing/read-data-open#power-bi" target="_blank" rel="noopener">read the shared data on Power BI by connecting to Azure Databricks using the Delta Sharing connector</a>.</p>